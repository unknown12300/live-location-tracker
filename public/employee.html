<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="https://shridevimedical.org/wp-content/uploads/2024/07/Shridevi_Medical-Logo.png" />
  <title>Share Your Location</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      max-width: 420px;
      width: 100%;
      padding: 40px 30px;
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 0 8px 25px rgba(0, 0, 0, 0.1);
      text-align: center;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
      background-size: 300% 100%;
      animation: gradientShift 3s ease infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .logo {
      width: 120px;
      height: auto;
      margin-bottom: 30px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    h2 {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      font-size: 16px;
      color: #718096;
      margin-bottom: 32px;
      font-weight: 400;
      line-height: 1.5;
    }

    input {
      padding: 16px 20px;
      width: 100%;
      margin: 0 0 24px 0;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      background: #f8fafc;
      color: #2d3748;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    input::placeholder {
      color: #a0aec0;
      font-weight: 400;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .btn {
      flex: 1;
      padding: 16px 24px;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-transform: none;
      letter-spacing: 0.5px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-start {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
    }

    .btn-start:hover {
      background: linear-gradient(135deg, #38a169, #2f855a);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
    }

    .btn-stop {
      background: linear-gradient(135deg, #f56565, #e53e3e);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
    }

    .btn-stop:hover {
      background: linear-gradient(135deg, #e53e3e, #c53030);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
    }

    .btn:disabled {
      background: #e2e8f0;
      color: #a0aec0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn:disabled::before {
      display: none;
    }

    #status {
      margin-top: 20px;
      font-size: 14px;
      font-weight: 400;
      min-height: 20px;
      word-break: break-word;
      color: transparent;
      font-size: 0;
    }

    .spinner {
       display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .container {
      animation: fadeIn 0.6s ease-out;
    }

    @media (max-width: 480px) {
      .container {
        margin: 10px;
        padding: 30px 20px;
      }

      .logo {
        width: 100px;
        margin-bottom: 24px;
      }

      h2 {
        font-size: 24px;
      }

      .subtitle {
        font-size: 15px;
        margin-bottom: 28px;
      }

      .button-group {
        flex-direction: column;
        gap: 12px;
      }

      .btn {
        padding: 14px 20px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://shridevimedical.org/wp-content/uploads/2024/07/Shridevi_Medical-Logo.png" alt="Shridevi Medical Logo" class="logo">
    
    <h2>üìç Share Your Location</h2>
    <p class="subtitle">Enter your Employee ID to start sharing.</p>

    <input type="text" id="employeeId" placeholder="Enter Employee ID" required />

    <div class="button-group">
      <button id="startBtn" class="btn btn-start" onclick="startSharing()">üü¢ Start Sharing</button>
      <button id="stopBtn" class="btn btn-stop" onclick="stopSharing()" disabled>üî¥ Stop Sharing</button>
    </div>

    <p id="status"></p>
  </div>

  <script>
    let watchId = null;
    let isSharing = false;

    // --- Local Storage Keys ---
    const EMPLOYEE_ID_KEY = 'employee_tracker_employeeId';
    const IS_SHARING_KEY = 'employee_tracker_isSharing';
    const LAST_LOCATION_KEY = 'employee_tracker_lastLocation'; // Still used for resume logic

    // --- Local Storage Helpers ---
    function saveState() {
        try {
            localStorage.setItem(EMPLOYEE_ID_KEY, document.getElementById('employeeId').value.trim());
            localStorage.setItem(IS_SHARING_KEY, isSharing.toString());
        } catch (e) {
            console.warn("Could not save state to localStorage:", e);
        }
    }

    function loadState() {
        try {
            const savedId = localStorage.getItem(EMPLOYEE_ID_KEY);
            const wasSharing = localStorage.getItem(IS_SHARING_KEY) === 'true';
            return { savedId, wasSharing, lastLocationData: {} }; // lastLocationData not used for display
        } catch (e) {
            console.warn("Could not load state from localStorage:", e);
            return { savedId: null, wasSharing: false, lastLocationData: {} };
        }
    }

    function clearState() {
        try {
            localStorage.removeItem(EMPLOYEE_ID_KEY);
            localStorage.removeItem(IS_SHARING_KEY);
            localStorage.removeItem(LAST_LOCATION_KEY);
        } catch (e) {
            console.warn("Could not clear state from localStorage:", e);
        }
    }

    function saveLastLocation(id, lat, lng, city) {
        try {
            // Keep saving last location for potential resume logic or beacon
            const locationData = {
                id,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                city,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(LAST_LOCATION_KEY, JSON.stringify(locationData));
        } catch (e) {
            console.warn("Could not save last location to localStorage:", e);
        }
    }

    // --- UI Update Functions ---
    // Modified updateStatus to be minimal or hidden
    function updateStatus(text, showSpinner = false) {
      // Option 1: Completely hide the status element
      // document.getElementById('status').style.display = 'none';

      // Option 2: Keep element but make content invisible (element still takes space)
      // This prevents layout shifts if buttons move
      const statusElement = document.getElementById('status');
      statusElement.textContent = ''; // Clear any text
      statusElement.style.color = 'transparent';
      statusElement.style.fontSize = '0';
      // Hide spinner
      // const spinnerHtml = showSpinner ? '<span class="spinner"></span>' : '';
      // statusElement.innerHTML = spinnerHtml; // Even if spinner is hidden, this would clear it

      // Option 3: Show only very generic messages (requires changing calls to updateStatus)
      /*
      const genericMessages = {
        'verifying': 'Verifying...',
        'finding': 'Finding location...',
        'sharing': 'Sharing...',
        'stopped': 'Stopped.',
        'resuming': 'Resuming...',
        'error': 'Error. Please try again.'
      };
      let genericText = '...'; // Default
      if (text.includes('Verifying')) genericText = genericMessages.verifying;
      else if (text.includes('Finding')) genericText = genericMessages.finding;
      else if (text.includes('Sharing location')) genericText = genericMessages.sharing; // Hides city
      else if (text.includes('stopped')) genericText = genericMessages.stopped;
      else if (text.includes('Resuming')) genericText = genericMessages.resuming;
      else if (text.includes('Failed') || text.includes('Error') || text.includes('Invalid') || text.includes('not found')) genericText = genericMessages.error;

      statusElement.textContent = genericText;
      statusElement.style.color = ''; // Reset color
      statusElement.style.fontSize = ''; // Reset font size
      */
    }


    // Function to update info is removed/commented out as it's no longer needed for display
    /*
    function updateInfo(id, lat, lng, city) {
      // This function is intentionally left blank or removed
      // Employee no longer sees their own location details
    }
    */


    // --- Geocoding ---
    function getCityName(lat, lng, callback) {
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=14`, {
        headers: {
          'User-Agent': 'EmployeeTracker/1.0 (contact@yourcompany.com)'
        }
      })
      .then(res => {
         if (!res.ok) {
             return res.text().then(text => {
                 throw new Error(`OSM HTTP error ${res.status}: ${text}`);
             });
         }
         return res.json();
      })
      .then(data => {
        let city = "Unknown Location";
        if (data.address) {
          city = [
            data.address.city,
            data.address.town,
            data.address.village,
            data.address.hamlet,
            data.address.suburb,
            data.address.state_district,
            data.address.state
          ].find(Boolean) || "Near " + (data.display_name.split(',')[0] || "Unknown Area");
        }
        callback(city);
      })
      .catch(err => {
        console.warn("Geocoding failed:", err);
        callback("City lookup failed");
      });
    }

    // --- Server Communication ---
    function sendLocation(id, lat, lng) {
      getCityName(lat, lng, (city) => {
          saveLastLocation(id, lat, lng, city);
          // Update status minimally or not at all for the employee
          // updateStatus(`üü¢ Sharing location: ${city}`); // <-- MODIFIED/HIDDEN
          updateStatus("Sharing..."); // Show a very generic message if desired, otherwise call with empty string or omit
      });

      fetch('/update-location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: id,
          latitude: lat,
          longitude: lng
        })
      })
      .then(res => {
         if (!res.ok) {
             console.error("Server update failed:", res.status, res.statusText);
         }
      })
      .catch(err => {
          console.error("‚ùå Network error sending location to server:", err);
          // updateStatus("‚ùå Network error sending location"); // <-- MODIFIED/HIDDEN
          updateStatus("Error sending location"); // Generic error message if needed
      });
    }

    function notifyStopSharing(id) {
      if (id) {
        fetch('/stop-sharing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id })
        })
        .catch(err => {
            console.warn("Error notifying server of stop-sharing:", err);
        });
      }
    }

    // --- Core Sharing Logic ---
    async function startSharing() {
      const id = document.getElementById('employeeId').value.trim();

      if (!id) {
        alert("‚ö†Ô∏è Please enter your Employee ID");
        return;
      }

      localStorage.setItem(EMPLOYEE_ID_KEY, id);

      // updateStatus("üîç Verifying your ID...", true); // <-- MODIFIED/HIDDEN
      updateStatus("Verifying..."); // Generic message

      let exists = false;
      try {
        const res = await fetch(`/employee-exists/${encodeURIComponent(id)}`);
        if (!res.ok) {
            const errorText = await res.text().catch(() => 'Unknown error');
            throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        const data = await res.json();
        exists = data.exists;
      } catch (err) {
        console.error("ID verification failed:", err);
        // updateStatus("‚ùå Failed to verify ID. Check internet or contact admin."); // <-- MODIFIED/HIDDEN
        updateStatus("Verification failed"); // Generic message
        return;
      }

      if (!exists) {
        // updateStatus(`<span style="color: #d9534f;">‚ùå Employee ID <b>${id}</b> not found. Contact your manager.</span>`); // <-- MODIFIED/HIDDEN
         updateStatus("ID not found"); // Generic message
        return;
      }

      if (!navigator.geolocation) {
        // updateStatus("‚ùå Browser doesn't support GPS."); // <-- MODIFIED/HIDDEN
        updateStatus("GPS not supported"); // Generic message
        return;
      }

      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      isSharing = true;
      saveState();
      // updateStatus("üîç Finding your location...", true); // <-- MODIFIED/HIDDEN
      updateStatus("Finding location..."); // Generic message

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          sendLocation(id, latitude, longitude);
        },
        (err) => {
          console.error("Geolocation error:", err);
          // updateStatus(`‚ùå Geolocation Error: ${err.message} (${err.code})`); // <-- MODIFIED/HIDDEN
          updateStatus("Location error"); // Generic message
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 5000
        }
      );
    }

    function stopSharing() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      const id = document.getElementById('employeeId').value.trim();
      isSharing = false;
      clearState();

      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      // updateStatus("üõë Location sharing stopped."); // <-- MODIFIED/HIDDEN
      updateStatus("Stopped."); // Generic message

      notifyStopSharing(id);
    }

    // --- Page Load Logic ---
    window.addEventListener('DOMContentLoaded', () => {
        const { savedId, wasSharing } = loadState();

        if (savedId) {
            document.getElementById('employeeId').value = savedId;
        }

        if (wasSharing && savedId) {
            // updateStatus("üîÅ Resuming sharing..."); // <-- MODIFIED/HIDDEN
            updateStatus("Resuming..."); // Generic message
            setTimeout(() => {
                 startSharing().catch(err => {
                     console.error("Error auto-starting sharing:", err);
                     // updateStatus("‚ùå Failed to resume sharing automatically."); // <-- MODIFIED/HIDDEN
                     updateStatus("Resume failed"); // Generic message
                 });
            }, 500);
        }
        // Initial status is now empty or generic due to CSS/HTML
    });

    // --- Cleanup on Tab Close/Navigate Away ---
    window.addEventListener('beforeunload', (e) => {
      saveState();

      if (isSharing) {
        const id = document.getElementById('employeeId').value.trim();
        if (id) {
          const beaconData = {
            id: id
          };
          const blob = new Blob([JSON.stringify(beaconData)], { type: 'application/json' });

          if (navigator.sendBeacon) {
             const success = navigator.sendBeacon('/stop-sharing', blob);
             if (!success) {
                 console.warn("sendBeacon failed, stop-sharing might not be sent.");
             }
          } else {
             console.warn("sendBeacon not supported, stop-sharing might not be sent reliably.");
          }
        }
      }

      if (isSharing) {
         e.returnValue = '';
         return '';
      }
    });

  </script>
</body>
</html>
